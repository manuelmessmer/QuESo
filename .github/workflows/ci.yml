name: CI

on:
  pull_request:
    branches: [ "main" ]

# for cancelling redundant runs
concurrency:
  group: ci-${{ github.head_ref }}
  cancel-in-progress: true

env:
  # Customize the CMake build type here (Release, Debug, RelWithDebInfo, etc.)
  BUILD_TYPE: Release
  compiler: gcc

jobs:
  # ubuntu:
  #   # The CMake configure and build commands are platform agnostic and should work equally well on Windows or Mac.
  #   # You can convert this to a matrix build if you need cross-platform coverage.
  #   # See: https://docs.github.com/en/free-pro-team@latest/actions/learn-github-actions/managing-complex-workflows#using-a-build-matrix
  #   runs-on: ubuntu-latest

  #   steps:
  #   - uses: actions/checkout@v3
  #     with:
  #       submodules: 'false'

  #   - name: Install Dependencies
  #     run: sudo apt-get install -y libboost-test-dev

  #   - name: Build
  #     shell: bash
  #     # Build your program with the given configuration
  #     run: |
  #       export CC=/usr/bin/gcc
  #       export CXX=/usr/bin/g++
  #       cp .github/workflows/configure.sh configure.sh
  #       bash configure.sh

  #   - name: Test py
  #     shell: bash
  #     run: |
  #       pip3 install numpy
  #       pip3 install scipy
  #       export PYTHONPATH=${PYTHONPATH}:${GITHUB_WORKSPACE}
  #       export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:${GITHUB_WORKSPACE}/libs
  #       python3 tibra/tests/test_tibra.py

  #   - name: Test cpp
  #     shell: bash
  #     run: ./TestExecutables/test_tibra --log_level=test_suite

  windows:
    runs-on: windows-latest
    env:
      BUILD_TYPE: Release

    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-python@v1
      with:
        python-version: '3.8'

    - name: Download boost
      run: |
        $url = "https://sourceforge.net/projects/boost/files/boost/1.74.0/boost_1_74_0.tar.gz/download"
        (New-Object System.Net.WebClient).DownloadFile($url, "$env:TEMP\boost.tar.gz")
        7z.exe x "$env:TEMP\boost.tar.gz" -o"\TEMP\boostArchive" -y | Out-Null
        7z.exe x "\TEMP\boostArchive" -o"\TEMP\boost" -y | Out-Null

    - name: Build boost unit test framework
      shell: cmd
      run: |
        cd \TEMP\boost
        bootstrap.bat
        b2 address-model=64 architecture=x86 --with-test link=shared --prefix=boost_install install

    - name: Installing dependencies
      shell: cmd
      run: |
        pip install numpy
        pip install scipy

    - name: Build
      shell: cmd
      run: |
        copy .\.github\workflows\configure.cmd
        configure.cmd

    - name: Test py
      shell: cmd
      run: |
        export PYTHONPATH=${PYTHONPATH}:${GITHUB_WORKSPACE}
        export LD_LIBRARY_PATH=${LD_LIBRARY_PATH}:${GITHUB_WORKSPACE}/libs
        set PYTHONPATH=%PYTHONPATH%;%GITHUB_WORKSPACE%
        set PATH=%PATH%;%GITHUB_WORKSPACE%/libs
        set PATH=%PATH%;\TEMP\boost\boost_install\lib
        py tibra/tests/test_tibra.py

    # - name: Test cpp
    #   shell: cmd
    #   run: "TestExecutables\Release\test_tibra.exe" --log_level=test_suite


